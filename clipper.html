<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Memeportal — Clipper</title>
<link rel="stylesheet" href="style.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  /* page-specific helpers (fixed) */
  .stage{position:relative;background:#0b0f17;border:1px solid var(--border);border-radius:14px;min-height:220px;max-height:60vh;display:grid;place-items:center;padding:8px}
  .player{width:100%;height:100%;aspect-ratio:16/9;display:grid;place-items:center}
  .stage video{width:100%;height:100%;object-fit:contain;border-radius:12px;background:#000}
  .progress{width:100%;height:10px;border-radius:999px;background:#1a2034;overflow:hidden;border:1px solid var(--border)}
  .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
  .clips{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
  .clip-card video{width:100%;height:auto;background:#000;border-radius:10px}
  .muted-note{font-size:11px;color:#9aa6c6}
  .clips-header{position:sticky;top:8px;z-index:3;background:transparent;padding:6px 0}
  @media (max-width:900px){
    .stage{max-height:46vh}
  }
</style>
</head>
<body>
  <div id="site-header"></div>
  <script>
    // load shared nav + burger
    (async()=>{try{
      const host = document.getElementById('site-header');
      host.innerHTML = await (await fetch('nav.html')).text();
      const btn=host.querySelector('.menu-toggle'), menu=host.querySelector('#mobileMenu');
      if(!btn||!menu) return;
      const close=()=>{menu.setAttribute('hidden','');btn.setAttribute('aria-expanded','false');document.removeEventListener('click',away);}
      const open =()=>{menu.removeAttribute('hidden');btn.setAttribute('aria-expanded','true');setTimeout(()=>document.addEventListener('click',away),0)}
      const away=e=>{if(!menu.contains(e.target)&&!btn.contains(e.target)) close();}
      btn.addEventListener('click',e=>{e.stopPropagation();menu.hasAttribute('hidden')?open():close();});
      window.matchMedia('(min-width:900px)').addEventListener?.('change',e=>{if(e.matches) close();});
      close();
    }catch(e){console.warn('nav load failed',e)}})();
  </script>

  <div class="app" style="grid-template-columns:420px minmax(0,1fr)">
    <aside>
      <!-- Upload -->
      <div class="card section">
        <h2>Video</h2>
        <div id="drop" class="drop">
          <input id="videoFile" type="file" accept="video/*">
          <div><strong>Drag & drop</strong> a video or <button class="btn ghost" id="browseBtn">Browse</button></div>
          <div class="tiny muted" style="margin-top:6px">MP4/WebM recommended. Processed 100% in your browser.</div>
        </div>
        <div id="videoInfo" class="footer">No video loaded.</div>
      </div>

      <!-- Settings -->
      <div class="card section">
        <h2>Clips & length</h2>
        <div class="grid">
          <div class="range-wrap">
            <label>Number of clips</label>
            <input id="clipCount" type="range" min="1" max="30" value="5">
            <span id="clipCountLabel" class="tiny muted">5</span>
          </div>
          <div class="range-wrap">
            <label>Average clip length (seconds)</label>
            <input id="clipLen" type="range" min="1" max="30" value="6">
            <span id="clipLenLabel" class="tiny muted">6</span>
          </div>
          <div class="flex"><input id="randomDur" type="checkbox" checked><label for="randomDur" style="margin:0">Vary durations randomly (±50%)</label></div>
          <div class="flex"><input id="avoidCuts" type="checkbox"><label for="avoidCuts" style="margin:0">Heuristic: nudge away from big scene changes</label></div>
        </div>
      </div>

      <!-- Export -->
      <div class="card section">
        <h2>Export</h2>
        <div class="grid two">
          <div>
            <label>Format</label>
            <select id="exportFormat">
              <option value="webm" selected>WebM (fast)</option>
              <option value="mp4">MP4 label (falls back to WebM)</option>
            </select>
          </div>
          <div>
            <label>FPS</label>
            <input id="fps" type="number" min="10" max="60" value="30">
          </div>
        </div>
        <div class="toolbar" style="margin-top:10px;justify-content:flex-end">
          <button class="btn" id="clearBtn">Clear</button>
          <button class="btn primary" id="generateBtn">Generate clips</button>
        </div>
        <div id="progressWrap" class="hidden" style="margin-top:10px">
          <div class="tiny muted" style="margin-bottom:6px">Progress</div>
          <div class="progress"><div id="progressBar" class="bar"></div></div>
          <div id="progressText" class="tiny muted" style="margin-top:6px">Starting…</div>
        </div>
        <div class="muted-note" style="margin-top:8px">Note: Most browsers can’t encode MP4 via MediaRecorder; you’ll still get WebM.</div>
      </div>
    </aside>

    <main>
      <div class="card section" style="height:100%;display:grid;grid-template-rows:auto auto minmax(220px,1fr) auto">
        <div class="kicker">Preview</div>
        <div class="hr"></div>

        <!-- BOUNDED PLAYER -->
        <div class="stage checker">
          <div class="player"><video id="mainPreview" controls playsinline></video></div>
        </div>

        <!-- Sticky header + clips grid -->
        <div style="margin-top:14px">
          <div class="clips-header flex" style="justify-content:space-between;align-items:center;margin-bottom:8px">
            <h1 style="font-size:18px;margin:0">Generated clips</h1>
            <button id="downloadAllBtn" class="btn success">Download All (ZIP)</button>
          </div>
          <div id="clipsGrid" class="clips"></div>
        </div>
      </div>
    </main>
  </div>

<!-- Hidden processing elements -->
<video id="processingVideo" style="display:none" playsinline></video>
<canvas id="processingCanvas" style="display:none"></canvas>

<script>
(function(){
  // helpers
  const $ = id => document.getElementById(id);
  const fmtTime = s => { if(!isFinite(s)) return '--:--'; const m=Math.floor(s/60).toString().padStart(2,'0'); const sec=Math.floor(s%60).toString().padStart(2,'0'); return m+':'+sec; };

  // els
  const videoFile=$('videoFile'), browseBtn=$('browseBtn'), mainPreview=$('mainPreview'), pVideo=$('processingVideo'), pCanvas=$('processingCanvas');
  const clipCount=$('clipCount'), clipLen=$('clipLen'), clipCountLabel=$('clipCountLabel'), clipLenLabel=$('clipLenLabel');
  const randomDur=$('randomDur'), avoidCuts=$('avoidCuts'), exportFormat=$('exportFormat'), fps=$('fps');
  const generateBtn=$('generateBtn'), clearBtn=$('clearBtn'), downloadAllBtn=$('downloadAllBtn'), clipsGrid=$('clipsGrid');
  const progressWrap=$('progressWrap'), progressBar=$('progressBar'), progressText=$('progressText'), videoInfo=$('videoInfo');

  let userFile=null, clips=[];

  // UI binds
  browseBtn.addEventListener('click',()=>videoFile.click());
  clipCount.addEventListener('input',()=>clipCountLabel.textContent=clipCount.value);
  clipLen.addEventListener('input',()=>clipLenLabel.textContent=clipLen.value);

  // upload
  videoFile.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    userFile=f; const url=URL.createObjectURL(f);
    mainPreview.src=url; pVideo.src=url; mainPreview.load(); pVideo.load();
    const setAspect=()=>{ const r = mainPreview.videoWidth / mainPreview.videoHeight; const wrap = document.querySelector('.player'); wrap.style.aspectRatio = (isFinite(r) && r>0) ? r : '16/9'; };
    mainPreview.addEventListener('loadedmetadata', ()=>{ updateInfo(f); setAspect(); }, {once:true});
  });
  function updateInfo(f){
    videoInfo.innerHTML = `Duration: <strong>${fmtTime(pVideo.duration)}</strong> • Resolution: <strong>${pVideo.videoWidth}×${pVideo.videoHeight}</strong> • Size: <strong>${(f.size/1024/1024).toFixed(2)} MB</strong>`;
  }

  clearBtn.addEventListener('click', ()=>{
    userFile=null; videoFile.value=''; mainPreview.removeAttribute('src'); pVideo.removeAttribute('src');
    clips=[]; clipsGrid.innerHTML=''; videoInfo.textContent='No video loaded.';
  });

  // scene-change heuristic
  async function nudgeStarts(starts){
    return new Promise(resolve=>{
      const v=pVideo, ctx=pCanvas.getContext('2d');
      const W=320, H=Math.max(1,Math.round((v.videoHeight/v.videoWidth)*W));
      pCanvas.width=W; pCanvas.height=H;
      const total=v.duration, samples=Math.min(60, Math.round(total)), times=[...Array(samples)].map((_,i)=>i*(total/samples));
      const bright=[]; let idx=0;
      function sampleNext(){
        if(idx>=times.length){
          const delta=bright.map((b,i)=>i?Math.abs(b-bright[i-1]):0);
          const gMax=Math.max(...delta, 1);
          for(const s of starts){
            const pos=Math.floor((s.start/total)*delta.length);
            const local=Math.max(...delta.slice(Math.max(0,pos-2), Math.min(delta.length,pos+3)));
            if(local > gMax*0.65) s.start=Math.max(0, s.start- (0.8+Math.random()*0.6));
          }
          return resolve();
        }
        v.currentTime=Math.min(v.duration-0.01, times[idx]);
        v.addEventListener('seeked', ()=>{
          try{ ctx.drawImage(v,0,0,W,H);}catch(e){}
          const d=ctx.getImageData(0,0,W,H).data; let sum=0;
          for(let i=0;i<d.length;i+=4) sum += (d[i]+d[i+1]+d[i+2])/3;
          bright.push(sum/(d.length/4)); idx++; setTimeout(sampleNext,40);
        }, {once:true});
      }
      v.pause(); sampleNext();
    });
  }

  // capture a segment via MediaRecorder on a canvas stream
  function captureSegment(start,dur,w,h,fpsVal){
    return new Promise((resolve,reject)=>{
      const ctx=pCanvas.getContext('2d');
      pCanvas.width=w; pCanvas.height=h;

      const stream=pCanvas.captureStream(Math.max(10,Math.min(60,fpsVal||30)));
      let mime='video/webm;codecs=vp9';
      let rec;
      try{ rec=new MediaRecorder(stream,{mimeType:mime}); }catch(e){ try{ rec=new MediaRecorder(stream); }catch(err){ return reject(new Error('MediaRecorder unsupported in this browser.')); } }

      const chunks=[];
      rec.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
      rec.onstop = ()=> resolve(new Blob(chunks,{type:mime}));

      // seek then play & draw frames
      pVideo.pause();
      pVideo.currentTime=Math.max(0, Math.min(pVideo.duration-0.01, start));
      const vidW=pVideo.videoWidth||1280, vidH=pVideo.videoHeight||720;

      pVideo.addEventListener('seeked', ()=>{
        const t0=performance.now(); rec.start(200);
        pVideo.muted=true; pVideo.play().catch(err=>reject(new Error('Autoplay blocked — click the page then try again.')));
        (function draw(){
          // cover scaling
          const scale=Math.max(w/vidW, h/vidH);
          const sw=w/scale, sh=h/scale, sx=(vidW-sw)/2, sy=(vidH-sh)/2;
          try{ ctx.drawImage(pVideo, sx, sy, sw, sh, 0, 0, w, h); }catch(e){}
          const elapsed=(performance.now()-t0)/1000;
          if(elapsed>=dur){ pVideo.pause(); rec.stop(); return; }
          requestAnimationFrame(draw);
        })();
      }, {once:true});
    });
  }

  // generate
  async function generate(){
    if(!userFile) return alert('Upload a video first.');
    const total=pVideo.duration; if(!isFinite(total)||total<=0) return alert('Unable to read video duration.');
    const n=+clipCount.value, avg=+clipLen.value;

    // compute starts
    const starts=[];
    for(let i=0;i<n;i++){
      let d=avg; if(randomDur.checked){ const delta=avg*0.5; d=Math.max(0.5, avg - delta + Math.random()* (2*delta)); }
      const s=Math.random()*Math.max(0,total-d);
      starts.push({start:s, dur:d});
    }
    if(avoidCuts.checked){
      progressWrap.classList.remove('hidden'); progressText.textContent='Scanning for scene changes…'; progressBar.style.width='10%';
      await nudgeStarts(starts);
    }

    progressWrap.classList.remove('hidden'); progressText.textContent='Generating…'; progressBar.style.width='12%';
    clips=[]; clipsGrid.innerHTML='';
    const w=pVideo.videoWidth||1280, h=pVideo.videoHeight||720, f=Math.max(10,Math.min(60,+fps.value||30));

    for(let i=0;i<starts.length;i++){
      const {start,dur}=starts[i];
      progressText.textContent=`Clip ${i+1} of ${starts.length}`;
      progressBar.style.width = `${Math.round(((i)/starts.length)*88)+12}%`;
      try{
        const blob=await captureSegment(start,dur,w,h,f);
        const url=URL.createObjectURL(blob);
        const obj={blob,url,idx:i+1,start,dur};
        clips.push(obj); addClipCard(obj);
      }catch(e){ console.error(e); const p=document.createElement('div'); p.textContent=`Failed to create clip ${i+1}`; clipsGrid.appendChild(p); }
    }
    progressBar.style.width='100%'; progressText.textContent=`Done — ${clips.length} clips ready.`;
  }

  function addClipCard(c){
    const wrap=document.createElement('div'); wrap.className='card section clip-card';
    wrap.innerHTML = `
      <div class="checker" style="border-radius:10px;overflow:hidden;margin-bottom:8px"><video controls src="${c.url}"></video></div>
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div class="tiny muted">Clip ${c.idx} • ${fmtTime(c.start)} • ${Math.round(c.dur)}s</div>
        <div class="toolbar">
          <a class="btn" download="clip-${c.idx}.${exportFormat.value==='mp4'?'mp4':'webm'}" href="${c.url}">Download</a>
        </div>
      </div>
    `;
    clipsGrid.appendChild(wrap);
  }

  // zip all
  downloadAllBtn.addEventListener('click', async ()=>{
    if(!clips.length) return alert('No clips yet.');
    const zip=new JSZip();
    for(let i=0;i<clips.length;i++){
      const arr=await clips[i].blob.arrayBuffer();
      zip.file(`clip-${i+1}.${exportFormat.value==='mp4'?'mp4':'webm'}`, arr);
    }
    const content=await zip.generateAsync({type:'blob'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(content); a.download='clips.zip'; a.click();
  });

  generateBtn.addEventListener('click', async ()=>{
    generateBtn.disabled=true; generateBtn.textContent='Working…';
    try{ await generate(); } finally { generateBtn.disabled=false; generateBtn.textContent='Generate clips'; }
  });

  // minimal DnD for video
  const drop=$('drop');
  ['dragenter','dragover'].forEach(evt=>drop.addEventListener(evt,e=>{e.preventDefault();drop.classList.add('drag');}));
  ;['dragleave','drop'].forEach(evt=>drop.addEventListener(evt,e=>{e.preventDefault();drop.classList.remove('drag');}));
  drop.addEventListener('drop', e=>{const f=e.dataTransfer.files?.[0]; if(f){ videoFile.files=e.dataTransfer.files; videoFile.dispatchEvent(new Event('change')); }});
})();
</script>
</body>
</html>
